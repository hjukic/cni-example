apiVersion: batch/v1
kind: CronJob
metadata:
  name: uptime-kuma-backup
  namespace: uptime-kuma
spec:
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 2
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: uptime-kuma-backup
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: bitnami/kubectl:latest
            command: [sh, -c]
            args:
            - |
              apt-get update -qq && apt-get install -y -qq sqlite3 > /dev/null 2>&1
              
              mkdir -p /backup
              BACKUP_FILE="/backup/kuma-backup-$(date +%Y%m%d-%H%M%S).db"
              
              sqlite3 /data/kuma.db ".backup '$BACKUP_FILE'"
              echo "✓ Backup created: $BACKUP_FILE"
              
              # Keep last 7 backups
              cd /backup && ls -t kuma-backup-*.db | tail -n +8 | xargs -r rm
              
              # Create ConfigMap
              BASE64_DATA=$(base64 -w 0 "$BACKUP_FILE")
              cat <<EOF | kubectl apply -f -
              apiVersion: v1
              kind: ConfigMap
              metadata:
                name: uptime-kuma-db-backup
                namespace: uptime-kuma
              binaryData:
                kuma.db: $BASE64_DATA
              EOF
              
              echo "✓ ConfigMap updated"
            volumeMounts:
            - name: data
              mountPath: /data
            - name: backup
              mountPath: /backup
          volumes:
          - name: data
            persistentVolumeClaim:
              claimName: uptime-kuma-pvc
          - name: backup
            persistentVolumeClaim:
              claimName: uptime-kuma-backup
